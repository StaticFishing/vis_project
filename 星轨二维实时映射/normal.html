<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Satellite Position</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/satellite.js@2.0.0/dist/satellite.min.js"></script>
    <style>
        svg {
            border: 1px solid black;
        }
        /* 卫星信息显示框的样式 */
       /* 卫星信息显示框的样式 */
       #satelliteInfo {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8); /* 半透明背景 */
            border: 1px solid #333;
            padding: 10px;
            font-size: 14px;
            display: none; /* 默认隐藏 */
            pointer-events: none; /* 不阻止鼠标事件 */
            z-index: 9999; /* 确保信息框显示在所有元素上方 */
            max-width: 300px;
        }
    </style>
</head>
<body>
    
    <svg width="1600" height="1200"></svg>
    <div id="satelliteInfo"></div> <!-- 卫星信息显示框 -->

    <script>
    
        
           
        const svg = d3.select("svg").append('g').attr("transform", "translate(790,800)");
        const width = +svg.attr("width");
        const height = +svg.attr("height");

        // 使用 Mercator 投影
        const projection = d3.geoMercator()
            .scale(250)  // 设置初始的缩放比例
            .translate([width / 2, height / 1.5]);

        const path = d3.geoPath().projection(projection);

        // 请求TLE数据的函数，使用 Celestrak API 获取卫星TLE
        function getTLEData() {
            const url = 'https://www.celestrak.com/NORAD/elements/stations.txt'; // 获取卫星TLE数据

            return fetch(url)
                .then(response => response.text())
                .then(text => {
                    const lines = text.trim().split('\n');
                    const satellites = [];
                    for (let i = 0; i < lines.length; i += 3) {
                        const name = lines[i].trim();
                        const tleLine1 = lines[i + 1].trim();
                        const tleLine2 = lines[i + 2].trim();

                        if (name && tleLine1 && tleLine2) {
                            satellites.push({
                                name: name,
                                tle: [tleLine1, tleLine2]
                            });
                        }
                    }
                    return satellites;
                })
                .catch(error => {
                    console.error("Error fetching TLE data:", error);
                    return [];
                });
        }

        // 请求卫星实时位置的模拟函数
        function getSatellitePosition(tle) {
            const satrec = satellite.twoline2satrec(tle[0], tle[1]);  // 解析TLE数据
            const now = new Date();
            const positionAndVelocity = satellite.propagate(satrec, now);  // 计算卫星位置和速度
            const position = positionAndVelocity.position;
            const gmst = satellite.gstime(now);
            const positionGd    = satellite.eciToGeodetic(position, gmst);
            console.error("Error fetching TLE data:", positionGd.longitude);
            // 将卫星位置转为经纬度
            if (positionGd) {
                const longitude = satellite.degreesLong(positionGd.longitude);
                const latitude = satellite.degreesLat(positionGd.latitude);
                const height = positionGd.height
                return { lon: longitude, lat:  latitude,h : height};
            } else {
                return { lon: 0, lat: 0 ,height : 0};
            }
        }

        // 卫星信息框
        const infoBox = d3.select("#satelliteInfo");

        // 显示卫星信息
        function showSatelliteInfo(position, event) {
            console.log("showSatelliteInfo triggered");  // 确认函数是否被调用
            console.log(position);  // 打印点击时的卫星数据
            
            const mouseX = event.pageX;
            const mouseY = event.pageY;

            // 打印鼠标坐标
            console.log("Mouse position:", mouseX, mouseY);

            // 显示卫星信息框，位置跟随鼠标
            infoBox.style("display", "block")
                .style("top", (mouseY + 10) + "px")  // 显示框跟随鼠标位置
                .style("left", (mouseX + 10) + "px")
                .html(
                    `<strong>卫星名称:</strong> ${position.name}<br>
                    <strong>经度:</strong> ${position.lon.toFixed(2)}<br>
                    <strong>纬度:</strong> ${position.lat.toFixed(2)}`
                );
        }

        // 隐藏卫星信息框
        function hideSatelliteInfo() {
            infoBox.style("display", "none");
        }

        Promise.all([
            d3.json('world.json'),  // 获取世界地图数据
            getTLEData()  // 获取卫星TLE数据
        ]).then(([geodata, satellites]) => {
            if (geodata.features) {
                // 绘制世界地图
                svg.selectAll("path")
                    .data(geodata.features)
                    .enter()
                    .append("path")
                    .attr("class", "country")
                    .attr("d", path)
                    .attr('fill', 'lightgray')
                    .attr('stroke','#333')
                    .on("click", function(event, d) {
                        let countryName = d.properties.name; // 根据 GeoJSON 数据的结构，假设名称存储在 properties.name 中

                        svg.selectAll(".country-name").remove(); // 删除先前的名称显示

                        let [x, y] = d3.pointer(event);

                        svg.append("text")
                            .attr("class", "country-name")
                            .attr("x", x + 10)  // 文本稍微偏移
                            .attr("y", y - 10)
                            .attr("font-size", "12px")
                            .attr("fill", "black")
                            .text(countryName);
                    });

                // 绘制经纬度网格
                // 这里的代码同样可以用来绘制网格和经纬度线
                // ...

                // 为每颗卫星绘制路径和实时位置
                var satelliteDots = []
                satellites.forEach((satelliteData,index)=> {
                    const satelliteDot = svg.append("circle")
                        .attr("r", 12)  // 卫星图标的半径
                        .attr("fill", "yellow")
                        .attr("cx", projection([index*10, 0])[0]) // 初始化位置
                        .attr("cy", projection([index*10, 0])[1])
                        .style("cursor", "pointer")
                        .datum({ lon: 0, lat: 0, name: satelliteData.name })  // 添加卫星的初始数据
                        .on("mouseover", function(event) {
                            const position = d3.select(this).datum(); // 获取绑定的数据
                            showSatelliteInfo(position, event); // 显示卫星信息
                        })
                        .on("mouseout", hideSatelliteInfo); // 鼠标移开时隐藏信息框
                    satelliteDots.push(satelliteDot);
                    
                });

                // 动画：根据卫星实时位置更新
                function updateSatellitePosition() {
                        satellites.forEach((satelliteData,index)=> {
                            const position = getSatellitePosition(satelliteData.tle);
                            
                            // 更新卫星的位置
                            satelliteDots[index].datum({ lon: position.lon, lat: position.lat, name: satelliteData.name })
                                .attr("cx", projection([position.lon, position.lat])[0])
                                .attr("cy", projection([position.lon, position.lat])[1]);

                            // 每1.5秒更新卫星位置
                            setTimeout(updateSatellitePosition, 1500);  
                        });
                }

                updateSatellitePosition(); // 开始实时更新卫星位置

                // 隐藏信息框，点击地图其他区域时
                svg.on("click", hideSatelliteInfo);

            } else {
                console.error("Data format is incorrect");
            }
        }).catch(error => {
            console.error("Error loading the JSON data: ", error);
        });
    </script>
</body>
</html>
